name: Release OpenCode Plugin

on:
  push:
    branches: [main]
    paths:
      - 'cupcake-plugins/opencode/**'
  workflow_dispatch:

jobs:
  build-and-release:
    name: Build and Release Plugin
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        working-directory: cupcake-plugins/opencode
        run: bun install

      - name: Type check
        working-directory: cupcake-plugins/opencode
        run: bun run typecheck

      - name: Build plugin
        working-directory: cupcake-plugins/opencode
        run: bun run build

      - name: Generate checksum
        working-directory: cupcake-plugins/opencode/dist
        run: |
          sha256sum cupcake.js > cupcake.js.sha256
          echo "Generated checksum:"
          cat cupcake.js.sha256

      - name: Get commit info
        id: commit
        run: |
          echo "sha_short=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
          echo "date=$(date -u +%Y-%m-%d)" >> $GITHUB_OUTPUT

      - name: Update plugin release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: opencode-plugin-latest
          name: OpenCode Plugin (Latest)
          body: |
            Latest build of the Cupcake OpenCode plugin.
            
            This release is automatically updated when changes are merged to main.
            
            **Build:** ${{ steps.commit.outputs.sha_short }} (${{ steps.commit.outputs.date }})
            
            ## Files
            - `opencode-plugin.js` - The plugin file
            - `opencode-plugin.js.sha256` - SHA256 checksum
            
            ## Installation
            
            The plugin is automatically downloaded when you run:
            ```bash
            cupcake init --harness opencode
            ```
            
            Or manually download:
            ```bash
            curl -fsSL https://github.com/eqtylab/cupcake/releases/download/opencode-plugin-latest/opencode-plugin.js \
              -o .opencode/plugin/cupcake.js
            ```
          files: |
            cupcake-plugins/opencode/dist/cupcake.js#opencode-plugin.js
            cupcake-plugins/opencode/dist/cupcake.js.sha256#opencode-plugin.js.sha256
          make_latest: false
          prerelease: false
