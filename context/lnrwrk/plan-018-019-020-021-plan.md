# Plan for Plan 018-019-020

Created: 2025-07-28 (Consolidated from Plans 018, 019, 020)
Status: Completed

## Approach

This consolidated plan represents three interconnected phases that transformed Cupcake from a basic policy engine into a production-ready, Claude Code-integrated behavioral guidance system with a sophisticated TUI.

**Plan 018**: Complete TUI with real functionality - building the user experience foundation
**Plan 019**: Claude Code July 20 integration - leveraging transformative new capabilities  
**Plan 020**: Architectural simplification - removing overengineered features that hindered integration

The approach evolved from simple TUI completion to strategic platform transformation driven by external Claude Code updates.

## Phases

### Plan 018: TUI Foundation and User Experience (4 Phases)

**Phase 1: Core TUI Enhancements**
- Enhanced Navigation & UX: Graceful exits, keyboard consistency, help systems
- Real File Discovery & Preview: Multi-agent support, syntax highlighting, existing rules detection
- Custom Prompt Integration: Modal implementation with validation

**Phase 2: Real Rule Extraction Engine** 
- LLM Integration Module: Claude API integration with retry logic
- Replace Mock Implementations: Real-time extraction with progress tracking
- Extraction Features: Parallel processing, error recovery, rule categorization

**Phase 3: Policy Generation Engine**
- Policy Compiler Module: Real YAML generation from extracted rules
- Real Policy Generation: Proper hook event organization and validation
- Integration & Validation: Schema compliance and testing

**Phase 4: Meta-Prompt System**
- Prompt Engineering: Rule extraction prompts with context injection
- Quality Assurance: Response validation, confidence scoring, interactive refinement

### Plan 019: Claude Code July 20 Integration (5 Phases)

**Phase 1: The New Contract - Modernizing Communication Protocol**
- Update Core Decision Model: PolicyDecision ‚Üí EngineDecision, add Ask variant
- Refactor Response Handler: Remove exit code reliance, implement JSON-first communication
- Align Action Terminology: Rename Approve ‚Üí Allow for consistency

**Phase 2: Proactive Guidance - Context Injection Implementation**
- Create InjectContext Action: Enable proactive behavioral guidance
- Implement Special UserPromptSubmit Handling: Stdout and JSON injection modes
- Enable Dynamic Context: Template substitution and aggregation

**Phase 3: The User Workflow - Robust Hook Registration**
- Implement Sync Command: Automated settings.json management with intelligent merging
- Update TUI Configuration: Modern hook generation and example policies
- End-to-end Testing: Comprehensive sync command validation

**Phase 4: Intelligent Conditions - Stateful Guidance**
- Define StateQuery Condition: Session-aware policy evaluation
- Integrate StateManager: Connect state tracking to policy engine
- Expand State Query Engine: Support complex historical queries

**Phase 5: Power-Ups & Documentation**
- Integrate $CLAUDE_PROJECT_DIR: Project-relative command execution
- Add MCP Tool Matching: Model Context Protocol support
- Complete Documentation: State query examples and best practices

### Plan 020: Architectural Simplification (3 Phases)

**Phase 1: Core Logic Removal - Surgical StateQuery Elimination**
- Delete StateQuery Condition: Remove from condition enum and supporting types
- Remove Evaluation Logic: Clean up evaluation engine and context
- Remove State Loading: Simplify run command execution flow
- Delete Query Engine Module: Remove src/state/query.rs entirely

**Phase 2: Test Suite Cleanup**
- Delete Stateful Test Files: Remove stateful_context.rs and stateful_policies.rs
- Clean Up Remaining Tests: Fix compilation errors and remove obsolete references
- Update Integration Tests: Ensure all tests pass without StateQuery

**Phase 3: Documentation Scrub**
- Update README.md: Remove StateQuery features and examples
- Update docs/ Directory: Clean up all StateQuery references
- Verification: Ensure complete removal with no remaining references

## Technical Decisions

### Plan 018 Decisions
- **LLM Provider**: Claude API for rule extraction with fallback to local models
- **Extraction Strategy**: One prompt per file with context injection
- **Caching**: Cache extracted rules in .cupcake/cache/ for re-use
- **Parallelism**: Process up to 3 files concurrently to respect API limits
- **TUI Architecture**: Event-driven async system with real-time progress updates

### Plan 019 Decisions  
- **Abandon Exit-Code Communication**: Pure JSON output format for all responses
- **Rename Approve to Allow**: Maintain conceptual integrity with Claude Code docs
- **Centralize Response Generation**: Single source of truth for CupcakeResponse construction
- **Isolate Context Injection Logic**: Contain stdout behavior anomaly for UserPromptSubmit
- **JSON-First Contract**: Always exit 0, communicate decisions via structured JSON

### Plan 020 Decisions
- **Compiler-Driven Removal**: Use Rust compiler errors to guide complete StateQuery elimination
- **Preserve Core State**: Keep StateManager for update_state action and session tracking
- **Simplify Architecture**: Focus on core policy evaluation without overengineered features
- **Maintain Test Coverage**: Ensure full functionality while reducing complexity

## Integration Strategy

### Plan 018 ‚Üí 019 Transition
- TUI foundation enabled sophisticated sync command and hook registration
- Real extraction engine provided framework for rule compilation and validation
- Manual testing infrastructure supported rapid iteration during Claude Code integration

### Plan 019 ‚Üí 020 Transition  
- StateQuery complexity hindered Claude Code integration work
- Two-pass evaluation model proved sufficient for most use cases
- Simplification enabled focus on core value proposition without distractions

### Cross-Plan Dependencies
- TUI wizard generates hook configurations using sync command logic
- Context injection leverages extraction engine for dynamic guidance
- Policy generation uses simplified condition model without StateQuery
- All phases maintain security-first command execution principles

## Success Criteria

### Plan 018 Achieved
- ‚úÖ Complete UX: Smooth navigation, graceful exits, helpful error messages
- ‚úÖ Concurrent Extraction: Real-time rule extraction with progress tracking
- üîÑ LLM Integration: Stub implementation ready for production Claude API
- ‚úÖ TUI Foundation: 6-screen wizard with event-driven architecture

### Plan 019 Achieved  
- ‚úÖ JSON Protocol: Complete Claude Code July 20 compatibility
- ‚úÖ Context Injection: Proactive behavioral guidance via UserPromptSubmit
- ‚úÖ Sync Command: Automated hook registration with intelligent merging
- ‚úÖ Enhanced Actions: Ask permission type and InjectContext capability
- ‚ùå StateQuery: Implemented but later removed in Plan 020

### Plan 020 Achieved
- ‚úÖ Clean Architecture: StateQuery completely removed with no compilation errors
- ‚úÖ Test Suite Health: All 457 tests passing with simplified codebase
- ‚úÖ Documentation Accuracy: All references to StateQuery removed
- ‚úÖ Focus: Core policy evaluation without overengineered complexity

## Overall Impact

The three-plan sequence delivered:
1. **User Experience Foundation** (Plan 018): Production-ready TUI with real extraction capabilities
2. **Platform Integration** (Plan 019): Claude Code compatibility with transformative behavioral guidance
3. **Architectural Clarity** (Plan 020): Simplified, maintainable design focused on core value

This positions Cupcake as a mature, production-ready policy enforcement and behavioral guidance system ready for the next phase of development.