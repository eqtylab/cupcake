# Test-Driven Development Workflow Policies
# These policies encourage TDD practices by checking test execution history

policies:
  # Remind to run tests before committing
  - name: tdd-test-reminder
    description: Remind developers to run tests before committing
    hook_event: UserPromptSubmit
    matcher: "*"
    conditions:
      # Check if user is trying to commit
      - type: pattern
        field: prompt
        regex: "(?i)(commit|push|pr|pull request)"
      # Check if tests haven't been run recently (or failed)
      - type: not
        condition:
          type: state_query
          filter:
            tool: Bash
            command_contains: "test"
            result: success
            within_minutes: 15
    action:
      type: inject_context
      context: |
        üß™ Test-Driven Development Reminder:
        
        No recent successful test runs detected in the last 15 minutes.
        Consider running your test suite before committing:
        
        - npm test
        - cargo test
        - pytest
        - go test ./...
        
        This helps ensure your changes don't break existing functionality.
      use_stdout: true

  # Celebrate when following TDD practices
  - name: tdd-positive-reinforcement
    description: Positive feedback for running tests before commit
    hook_event: UserPromptSubmit
    matcher: "*"
    conditions:
      - type: pattern
        field: prompt
        regex: "(?i)(commit|push)"
      - type: state_query
        filter:
          tool: Bash
          command_contains: "test"
          result: success
          within_minutes: 10
    action:
      type: inject_context
      context: "‚úÖ Excellent TDD practice! Tests are passing and recent. You're good to commit! üéâ"
      use_stdout: true

  # Warn about test failures
  - name: tdd-test-failure-warning
    description: Warn when trying to commit with recent test failures
    hook_event: UserPromptSubmit
    matcher: "*"
    conditions:
      - type: pattern
        field: prompt
        regex: "(?i)(commit|push|merge)"
      - type: state_query
        filter:
          tool: Bash
          command_contains: "test"
          result: failure
          within_minutes: 30
    action:
      type: inject_context
      context: |
        ‚ö†Ô∏è  Recent test failures detected!
        
        Your test suite failed in the last 30 minutes. Please fix the failing tests before committing.
        This helps maintain code quality and prevents broken code from entering the repository.
        
        Run your tests again to see the specific failures.
      use_stdout: true

  # Suggest running specific test commands based on project type
  - name: tdd-project-specific-suggestions
    description: Provide project-specific test suggestions
    hook_event: PreToolUse
    matcher: Bash
    conditions:
      # User is trying to commit without recent tests
      - type: pattern
        field: tool_input.command
        regex: "git\\s+(commit|push)"
      - type: not
        condition:
          type: state_query
          filter:
            tool: Bash
            command_contains: "test"
            result: success
            within_minutes: 10
    action:
      type: provide_feedback
      feedback: |
        üí° Quick reminder: Run tests before committing!
        
        Based on your project, try one of these:
        - npm test (JavaScript/TypeScript)
        - cargo test (Rust)
        - go test ./... (Go)
        - pytest (Python)
        - bundle exec rspec (Ruby)